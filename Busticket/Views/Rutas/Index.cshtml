@model List<Busticket.Models.Ruta>

@{
    ViewBag.Title = "Busticket";
    Layout = null;
}

<!DOCTYPE html>
<html lang="es">
<head>
    <header class="py-6">
        <div class="w-[95%] max-w-[1400px] mx-auto flex items-center justify-between">

            <!-- Logo -->
            <div class="text-3xl font-extrabold text-[#284D67] cursor-pointer">
                <a href="/">Busticket</a>
            </div>

            <!-- Links -->
            <nav class="flex gap-12">
                <a href="#" class="text-base font-medium hover:text-[#002C53] hover:font-bold">Destinos</a>
                <a href="#" class="text-base font-medium hover:text-[#002C53] hover:font-bold">Planes</a>
                <a href="#" class="text-base font-medium hover:text-[#002C53] hover:font-bold">Descuentos</a>
            </nav>

            <!-- Iconos -->
            <div class="flex items-center">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='28' height='28' fill='%23284D67' viewBox='0 0 24 24'><path d='M7 18c-1.104 0-2 .897-2 2 0 1.102.896 2 2 2 1.103 0 2-.898 2-2 0-1.103-.897-2-2-2zm10 0c-1.104 0-2 .897-2 2 0 1.102.896 2 2 2 1.103 0 2-.898 2-2 0-1.103-.897-2-2-2zM7.334 14h9.744c.83 0 1.553-.52 1.836-1.289l2.734-7.318A1 1 0 0 0 20.7 4H5.21l-.94-2.265A1 1 0 0 0 3.355 1H1v2h1.611l3.598 8.643-1.35 2.835A2 2 0 0 0 6.666 17H19v-2H7.334l1-1z'/></svg>"
                     class="w-7 ml-4 cursor-pointer">

                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='28' height='28' fill='%23284D67' viewBox='0 0 24 24'><path d='M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5zm0 2c-3.314 0-10 1.657-10 5v3h20v-3c0-3.343-6.686-5-10-5z'/></svg>"
                     class="w-7 ml-4 cursor-pointer">
            </div>

        </div>
    </header>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Busticket</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

    <style>
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="overflow-hidden font-sans bg-gray-50">

    <!-- BUSCADOR -->
    <form method="get" action="@Url.Action("Index", "Rutas")"
          class="w-[90%] mx-auto bg-[#002f5e] text-white rounded-full px-8 py-4 flex items-center justify-between mt-4">

        <div class="flex flex-col text-center">
            <label class="text-xs opacity-80">Desde</label>
            <input type="text" name="origen" value="@ViewData["origen"]"
                   placeholder="Ciudad…" class="bg-transparent outline-none text-sm text-center placeholder-gray-300" />
        </div>

        <div class="w-[1px] h-10 bg-white opacity-20"></div>

        <div class="flex flex-col text-center">
            <label class="text-xs opacity-80">Hasta</label>
            <input type="text" name="destino" value="@ViewData["destino"]"
                   placeholder="Ciudad…" class="bg-transparent outline-none text-sm text-center placeholder-gray-300" />
        </div>

        <button type="submit" class="bg-white text-[#002f5e] rounded-full p-3 hover:bg-gray-200 transition flex items-center justify-center">
            🔍
        </button>

    </form>

    <!-- CONTENIDO -->
    <div class="flex h-[calc(100vh-220px)] gap-4">
        <!-- LISTA DE RUTAS -->
        <div class="w-1/2 p-4 overflow-y-auto scrollbar-hide bg-white">
            <h3 class="text-xl font-semibold mb-4">@Model.Count rutas encontradas</h3>

            <div id="rutasContainer" class="flex flex-col gap-4">
                @foreach (var ruta in Model)
                {
                    <div class="ruta-card flex items-center justify-between p-4 bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition cursor-pointer"
                         data-id="@ruta.RutaId"
                         data-origen-lat="@ruta.OrigenLat"
                         data-origen-lng="@ruta.OrigenLng"
                         data-destino-lat="@ruta.DestinoLat"
                         data-destino-lng="@ruta.DestinoLng">

                        <!-- Imagen dinámica por ruta -->
                        <img src="https://picsum.photos/seed/@ruta.RutaId/200/130"
                             class="w-32 h-24 rounded-lg object-cover" />

                        <!-- Información -->
                        <div class="flex flex-col flex-grow px-4">
                            <p class="font-bold text-lg text-gray-800">@ruta.Origen — @ruta.Destino</p>
                            <p class="text-sm text-gray-500">Empresa: Expreso Brasilia</p>
                            <p class="text-sm text-gray-500">Tipo: Bus intermunicipal de larga distancia</p>
                            <p class="text-sm text-gray-500">Duración: @ruta.Duracion min</p>

                            <!-- Calificación -->
                            <div class="flex items-center gap-1 mt-1">
                                <span class="text-yellow-400 text-lg">★</span>
                                <span class="text-sm text-gray-700">5.0</span>
                            </div>
                        </div>

                        <!-- Precio y favorito -->
                        <div class="flex flex-col items-end">
                            <button class="fav-btn text-gray-400 hover:text-red-500 text-2xl transition">♡</button>
                            <p class="font-bold text-blue-900 mt-4">
                                $@ruta.Precio.ToString("N0") COP
                            </p>
                        </div>

                    </div>
                }
            </div>
        </div>

        <!-- MAPA -->
        <div class="w-1/2 h-full pt-8">
            <div id="map" class="w-full h-full rounded-xl shadow-lg"></div>
        </div>

    </div>

    <!-- SCRIPT DEL MAPA, FAVORITOS Y CLICK A DETALLE -->
    <script>
        // ---------- MAPA ----------
        var map = L.map('map').setView([10.9685, -74.7813], 7);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var routingControl = null;

        document.querySelectorAll('.ruta-card').forEach(function (card) {
            card.addEventListener('mouseenter', function () {
                var origenLat = parseFloat(card.dataset.origenLat);
                var origenLng = parseFloat(card.dataset.origenLng);
                var destinoLat = parseFloat(card.dataset.destinoLat);
                var destinoLng = parseFloat(card.dataset.destinoLng);

                if (routingControl) {
                    map.removeControl(routingControl);
                }

                routingControl = L.Routing.control({
                    waypoints: [
                        L.latLng(origenLat, origenLng),
                        L.latLng(destinoLat, destinoLng)
                    ],
                    lineOptions: {
                        styles: [{ color: '#00335c', weight: 5 }]
                    },
                    addWaypoints: false,
                    draggableWaypoints: false,
                    show: false
                }).addTo(map);

                map.fitBounds([
                    [origenLat, origenLng],
                    [destinoLat, destinoLng]
                ]);
            });
        });

        // ---------- FAVORITOS (solo frontend) ----------
        document.querySelectorAll('.fav-btn').forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.stopPropagation();
                if (btn.textContent === "♡") {
                    btn.textContent = "❤";
                    btn.classList.add("text-red-500");
                } else {
                    btn.textContent = "♡";
                    btn.classList.remove("text-red-500");
                }
            });
        });

        // ---------- CLICK EN CARD PARA DETALLE ----------
        document.querySelectorAll('.ruta-card').forEach(card => {
            card.addEventListener('click', function () {
                var rutaId = card.dataset.id;
                window.location.href = '/Rutas/info/' + rutaId;
            });
        });
    </script>

</body>
</html>
